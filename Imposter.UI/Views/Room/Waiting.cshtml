@model IEnumerable<PlayerViewModel>

@{

    ViewData["Title"] = "Waiting";

    var roomId = ViewBag.roomId;
    var playerId = ViewBag.PlayerId;
    //roomId
    var isHost = ViewBag.IsHost;
}
<!-- category selector -->
<div class="container py-5" style="margin-top:60px;">
    <h3 class="text-white mb-4 text-center">Waiting</h3>
    <!-- player cards -->
    <div class="row g-3 mb-4" id="playersList">
        @foreach (var itm in Model)
        {
            <div class="col-12 col-md-6 col-lg-4" id="@itm.playerId">
                <div class="card rounded-3 border-0 shadow"
                     style="background:rgba(27, 38, 59, .9);">
                    <div class="card-body d-flex justify-content-between align-items-center text-white">
                        <div>
                            <div class="fw-bold" style="font-size:1.1rem;">@itm.Name</div>
                        </div>
                        @if (itm.State)
                        {
                            <span class="badge rounded-pill"
                                  style="background:#00ff00; color:#000;">Ready</span>
                        }
                        else
                        {
                            <span class="badge rounded-pill"
                                  style="background:#ffff00; color:#000;">Not Ready</span>
                        }
                    </div>
                </div>
            </div>
        }


    </div>

    <!-- start game button -->
    @if (isHost)
    {
        <div class="text-center">
            <button id="startButton" onclick="Next()" class="btn btn-neon px-4 py-2 rounded-pill" disabled>
                Next
            </button>
        </div>
    }
    
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    var connection = new signalR.HubConnectionBuilder()
        .withUrl("/gameHub")
        .build();
    connection.start()
    .then(() => console.log("SignalR connected"))
    .catch(err => console.error(err.toString()));
    
    
    connection.on("NextStage" , (page)=>{
        debugger;

        redirectPost(`/room/@roomId/${page}`, {});
        // navigate manually
    });

    
    connection.on("PlayerReady", (player) => {
        // Find the player's div
        const playerDiv = document.getElementById(player.playerId);
        if (!playerDiv) return;

        // Find the current badge
        const oldBadge = playerDiv.querySelector(".badge");
        if (!oldBadge) return;

        // Create a new badge element
        const newBadge = document.createElement("span");
        newBadge.className = "badge rounded-pill";
        newBadge.style.background = "#00ff00";
        newBadge.style.color = "#000";
        newBadge.textContent = "Ready";

        // Replace the old badge with the new one
        oldBadge.replaceWith(newBadge);
    });

    
    
        

    connection.on("AllPlayersReady", () => {
        debugger;
        const startButton = document.getElementById("startButton");
        startButton.disabled = false;

    });
    connection.on("NotAllPlayersReady", () => {
        debugger;
        const startButton = document.getElementById("startButton");
        startButton.disabled = true;

    });
    function Next() {
        connection.invoke("NextStage","@roomId")
            .catch(err => console.error(err.toString()));
    }


    
</script>
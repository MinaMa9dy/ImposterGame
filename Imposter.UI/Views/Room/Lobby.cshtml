@model IEnumerable<PlayerViewModel>

@{
    ViewData["Title"] = "Lobby";
    var isHost = ViewBag.IsHost;
    var roomId = ViewBag.roomId;
}

<div class="container py-5" style="margin-top:60px;">
    <h3 class="text-white mb-4 text-center">Lobby</h3>

    <!-- player cards -->
    <div class="row g-3 mb-4" id="playersList">
        @foreach(var itm in Model)
        {
            <div class="col-12 col-md-6 col-lg-4" id="@itm.playerId">
                <div class="card rounded-3 border-0 shadow"
                style="background:rgba(27, 38, 59, .9);">
                    <div class="card-body d-flex justify-content-between align-items-center text-white">
                        <div>
                            <div class="fw-bold" style="font-size:1.1rem;">@itm.Name</div>
                            <small class="opacity-75">Score: @itm.Score</small>
                        </div>
                        @if (itm.State)
                        {
                            <span class="badge rounded-pill"
                            style="background:#00ff00; color:#000;">Ready</span>
                        }else
                        {
                            <span class="badge rounded-pill"
                            style="background:#ffff00; color:#000;">Not Ready</span>
                        }
                    </div>
                </div>
            </div>
        }


    </div>

    <!-- start game button -->
    @if (isHost)
    {
        <div class="text-center">
            <button class="btn rounded-pill px-5 py-2 fw-bold shadow"
                    style="border:2px solid #ff00cc; color:#ff00cc; background:transparent;
                       font-size:1.1rem; transition:all .3s ease;"
                    onmouseover="this.style.background='#ff00cc'; this.style.color='#fff';"
                    onmouseout="this.style.background='transparent'; this.style.color='#ff00cc';"
                    onclick="start()">
                Start Game
            </button>
        </div>
    }
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    var connection = new signalR.HubConnectionBuilder()
        .withUrl("/gameHub")
        .build();
    connection.start()
    .then(() => console.log("SignalR connected"))
    .catch(err => console.error(err.toString()));
    // Handle incoming messages

    
    function addPlayerCard(player) {
        const bg = player.state ? '#00ff00' : '#ffff00';
        const text = player.state ? 'Ready' : 'Not Ready';

        const html = `
            <div class="col-12 col-md-6 col-lg-4" id="${player.id}">
                <div class="card rounded-3 border-0 shadow"
                     style="background:rgba(27, 38, 59, .9);">
                    <div class="card-body d-flex justify-content-between align-items-center text-white">
                        <div>
                            <div class="fw-bold" style="font-size:1.1rem;">${player.name}</div>
                            <small class="opacity-75">Score: ${player.score}</small>
                        </div>
                        <span class="badge rounded-pill"
                              style="background:${bg}; color:#000;">${text}</span>
                    </div>
                </div>
            </div>`;

        document.getElementById('playersList').insertAdjacentHTML('beforeend', html);
    }


    // استقبال حدث userJoined
    connection.on("userJoined", (player) => {
        debugger;
        const normalizedPlayer = {
            id: player.playerId,
            name: player.name,
            score: player.score,
            state: player.state
        };
        addPlayerCard(normalizedPlayer);
    });

    connection.on("joinedSuccessfully", (player) => {

        
        addMessage('joined');
    });
    function addMessage(message) {
        const messagesDiv = document.getElementById("playersList");

        const msgRow = document.createElement("div");
        msgRow.classList.add("alert", "alert-info", "mt-2");
        msgRow.textContent = message;

        messagesDiv.appendChild(msgRow);
    }

    // استقبال حدث userLeft لو حبيت تمسح اللاعب
    connection.on("userLeft", p => {
        document.getElementById(p.playerId)?.remove();   // lower-case – matches DOM
    });
    connection.on("user1Left", (player) => {
        debugger;
        const row = document.getElementById(`${player.playerId}`);
        if (row) row.remove();
    });
    connection.on("NextStage" , ()=>{
        debugger;
        
        redirectPost(`/room/@roomId/SecretWord`, {});
        // navigate manually
    });
    
    


    function start() {
        debugger;
        connection.invoke("StartGame","@roomId")
            .catch(err => console.error(err.toString()));
    }
</script>